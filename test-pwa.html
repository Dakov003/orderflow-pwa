<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PWA OrderFlow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background-color: #d4edda; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .test-result { font-weight: bold; margin: 10px 0; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Test PWA OrderFlow - Verificare Funcționalități</h1>
    
    <div class="test-section">
        <h2>1. Testare LocalStorage</h2>
        <button onclick="testLocalStorage()">Testează LocalStorage</button>
        <div id="localStorage-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Testare Formatare Valută</h2>
        <button onclick="testCurrencyFormat()">Testează Formatare Valută</button>
        <div id="currency-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Testare Generare ID</h2>
        <button onclick="testIdGeneration()">Testează Generare ID</button>
        <div id="id-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Testare Logica Datorii</h2>
        <button onclick="testDebtLogic()">Testează Logica Datorii</button>
        <div id="debt-result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Testare Logica Plăți</h2>
        <button onclick="testPaymentLogic()">Testează Logica Plăți</button>
        <div id="payment-result"></div>
    </div>
    
    <div class="test-section">
        <h2>6. Testare PWA Manifest</h2>
        <button onclick="testPWAManifest()">Testează PWA Manifest</button>
        <div id="manifest-result"></div>
    </div>
    
    <div class="test-section">
        <h2>7. Testare Service Worker</h2>
        <button onclick="testServiceWorker()">Testează Service Worker</button>
        <div id="sw-result"></div>
    </div>
    
    <div class="test-section">
        <h2>8. Testare Offline Capability</h2>
        <button onclick="testOfflineCapability()">Testează Capacitatea Offline</button>
        <div id="offline-result"></div>
    </div>

    <script>
        // Funcții de test pentru OrderFlow PWA
        
        function formatCurrency(amount) {
            const numberAmount = typeof amount === 'number' ? amount : parseFloat(amount || 0);
            if (isNaN(numberAmount)) {
                return new Intl.NumberFormat('ro-RO', { style: 'currency', currency: 'RON' }).format(0);
            }
            return new Intl.NumberFormat('ro-RO', { style: 'currency', currency: 'RON' }).format(numberAmount);
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function createTimestamp() {
            return { toDate: () => new Date() };
        }
        
        function getLocalStorageData(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error(`Error reading ${key} from localStorage:`, error);
                return defaultValue;
            }
        }
        
        function setLocalStorageData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error(`Error saving ${key} to localStorage:`, error);
                return false;
            }
        }
        
        function testLocalStorage() {
            const result = document.getElementById('localStorage-result');
            let tests = [];
            
            // Test 1: Scriere și citire date
            const testData = [{ id: '1', name: 'Test Client' }];
            const writeSuccess = setLocalStorageData('test_customers', testData);
            const readData = getLocalStorageData('test_customers', []);
            tests.push({
                name: 'Scriere și citire localStorage',
                passed: writeSuccess && JSON.stringify(readData) === JSON.stringify(testData)
            });
            
            // Test 2: Valoare default
            const defaultData = getLocalStorageData('non_existent_key', []);
            tests.push({
                name: 'Valoare default pentru cheie inexistentă',
                passed: Array.isArray(defaultData) && defaultData.length === 0
            });
            
            // Test 3: Gestionare erori
            const invalidData = getLocalStorageData('invalid_json_key', []);
            tests.push({
                name: 'Gestionare erori JSON',
                passed: Array.isArray(invalidData)
            });
            
            displayResults(result, tests);
        }
        
        function testCurrencyFormat() {
            const result = document.getElementById('currency-result');
            let tests = [];
            
            const testCases = [
                { input: 123.45, expected: '123,45 RON' },
                { input: 0, expected: '0,00 RON' },
                { input: 'invalid', expected: '0,00 RON' },
                { input: null, expected: '0,00 RON' },
                { input: undefined, expected: '0,00 RON' },
                { input: 1000.99, expected: '1.000,99 RON' }
            ];
            
            testCases.forEach((testCase, index) => {
                const actual = formatCurrency(testCase.input);
                tests.push({
                    name: `Formatare ${testCase.input} (test ${index + 1})`,
                    passed: actual === testCase.expected,
                    details: `Așteptat: ${testCase.expected}, Obținut: ${actual}`
                });
            });
            
            displayResults(result, tests);
        }
        
        function testIdGeneration() {
            const result = document.getElementById('id-result');
            let tests = [];
            
            // Test 1: Generare ID unic
            const id1 = generateId();
            const id2 = generateId();
            tests.push({
                name: 'ID-uri sunt diferite',
                passed: id1 !== id2
            });
            
            // Test 2: ID este string
            tests.push({
                name: 'ID este string',
                passed: typeof id1 === 'string'
            });
            
            // Test 3: ID nu este gol
            tests.push({
                name: 'ID nu este gol',
                passed: id1.length > 0
            });
            
            // Test 4: ID conține caractere alfanumerice
            tests.push({
                name: 'ID conține caractere alfanumerice',
                passed: /^[a-z0-9]+$/i.test(id1)
            });
            
            displayResults(result, tests);
        }
        
        function testDebtLogic() {
            const result = document.getElementById('debt-result');
            let tests = [];
            
            const orders = [
                { id: '1', customerId: 'c1', totalAmount: 100, paidAmount: 50, status: 'Plătită Parțial' },
                { id: '2', customerId: 'c1', totalAmount: 200, paidAmount: 0, status: 'Deschisă' },
                { id: '3', customerId: 'c2', totalAmount: 150, paidAmount: 150, status: 'Plătită Integral' },
                { id: '4', customerId: 'c1', totalAmount: 75, paidAmount: 0, status: 'Stornată' }
            ];
            
            // Test 1: Calculul datoriilor pentru un client
            const client1Orders = orders.filter(o => o.customerId === 'c1' && o.status !== 'Stornată');
            const totalDebt = client1Orders.reduce((sum, o) => sum + (o.totalAmount - (o.paidAmount || 0)), 0);
            tests.push({
                name: 'Calculul datoriilor Client 1',
                passed: totalDebt === 250,
                details: `Datorie calculată: ${totalDebt}, Așteptat: 250`
            });
            
            // Test 2: Filtrarea comenzilor active
            const activeOrders = orders.filter(o => o.status !== 'Stornată' && o.status !== 'Plătită Integral');
            tests.push({
                name: 'Filtrarea comenzilor active',
                passed: activeOrders.length === 2,
                details: `Comenzi active: ${activeOrders.length}, Așteptat: 2`
            });
            
            // Test 3: Calculul datoriilor totale
            const allDebts = orders
                .filter(o => o.status !== 'Stornată' && o.status !== 'Plătită Integral')
                .reduce((sum, o) => sum + (o.totalAmount - (o.paidAmount || 0)), 0);
            tests.push({
                name: 'Calculul datoriilor totale',
                passed: allDebts === 250,
                details: `Datorii totale: ${allDebts}, Așteptat: 250`
            });
            
            displayResults(result, tests);
        }
        
        function testPaymentLogic() {
            const result = document.getElementById('payment-result');
            let tests = [];
            
            const orders = [
                { id: '1', totalAmount: 100, paidAmount: 0, status: 'Deschisă' },
                { id: '2', totalAmount: 200, paidAmount: 0, status: 'Deschisă' }
            ];
            
            const paymentAmount = 150;
            let remainingAmount = paymentAmount;
            const settlementDetails = [];
            
            // Simulăm procesarea plății
            for (const order of orders) {
                if (remainingAmount <= 0) break;
                
                const dueOnOrder = order.totalAmount - (order.paidAmount || 0);
                const amountToApply = Math.min(remainingAmount, dueOnOrder);
                
                if (amountToApply > 0) {
                    settlementDetails.push({
                        orderId: order.id,
                        amountSettled: amountToApply
                    });
                    remainingAmount -= amountToApply;
                }
            }
            
            const totalSettled = settlementDetails.reduce((sum, detail) => sum + detail.amountSettled, 0);
            const changeReturned = Math.max(0, paymentAmount - totalSettled);
            
            tests.push({
                name: 'Procesarea plății parțiale',
                passed: totalSettled === 150 && changeReturned === 0,
                details: `Decontat: ${totalSettled}, Rest: ${changeReturned}`
            });
            
            // Test cu plată completă
            const fullPaymentAmount = 300;
            let fullRemainingAmount = fullPaymentAmount;
            const fullSettlementDetails = [];
            
            for (const order of orders) {
                if (fullRemainingAmount <= 0) break;
                
                const dueOnOrder = order.totalAmount - (order.paidAmount || 0);
                const amountToApply = Math.min(fullRemainingAmount, dueOnOrder);
                
                if (amountToApply > 0) {
                    fullSettlementDetails.push({
                        orderId: order.id,
                        amountSettled: amountToApply
                    });
                    fullRemainingAmount -= amountToApply;
                }
            }
            
            const fullTotalSettled = fullSettlementDetails.reduce((sum, detail) => sum + detail.amountSettled, 0);
            const fullChangeReturned = Math.max(0, fullPaymentAmount - fullTotalSettled);
            
            tests.push({
                name: 'Procesarea plății complete',
                passed: fullTotalSettled === 300 && fullChangeReturned === 0,
                details: `Decontat: ${fullTotalSettled}, Rest: ${fullChangeReturned}`
            });
            
            displayResults(result, tests);
        }
        
        function testPWAManifest() {
            const result = document.getElementById('manifest-result');
            let tests = [];
            
            // Test 1: Verificare manifest
            fetch('/manifest.webmanifest')
                .then(response => {
                    tests.push({
                        name: 'Manifest este accesibil',
                        passed: response.ok
                    });
                    return response.json();
                })
                .then(manifest => {
                    tests.push({
                        name: 'Manifest are nume',
                        passed: manifest.name && manifest.name.length > 0
                    });
                    
                    tests.push({
                        name: 'Manifest are short_name',
                        passed: manifest.short_name && manifest.short_name.length > 0
                    });
                    
                    tests.push({
                        name: 'Manifest are icons',
                        passed: manifest.icons && manifest.icons.length > 0
                    });
                    
                    tests.push({
                        name: 'Manifest are display mode',
                        passed: manifest.display === 'standalone'
                    });
                    
                    displayResults(result, tests);
                })
                .catch(error => {
                    tests.push({
                        name: 'Manifest este accesibil',
                        passed: false,
                        details: `Eroare: ${error.message}`
                    });
                    displayResults(result, tests);
                });
        }
        
        function testServiceWorker() {
            const result = document.getElementById('sw-result');
            let tests = [];
            
            if ('serviceWorker' in navigator) {
                tests.push({
                    name: 'Service Worker este suportat',
                    passed: true
                });
                
                navigator.serviceWorker.getRegistrations()
                    .then(registrations => {
                        tests.push({
                            name: 'Service Worker este înregistrat',
                            passed: registrations.length > 0
                        });
                        
                        displayResults(result, tests);
                    })
                    .catch(error => {
                        tests.push({
                            name: 'Service Worker este înregistrat',
                            passed: false,
                            details: `Eroare: ${error.message}`
                        });
                        displayResults(result, tests);
                    });
            } else {
                tests.push({
                    name: 'Service Worker este suportat',
                    passed: false,
                    details: 'Service Worker nu este suportat în acest browser'
                });
                displayResults(result, tests);
            }
        }
        
        function testOfflineCapability() {
            const result = document.getElementById('offline-result');
            let tests = [];
            
            // Test 1: Verificare status online/offline
            tests.push({
                name: 'Status online detectat',
                passed: navigator.onLine !== undefined
            });
            
            // Test 2: Verificare cache API
            if ('caches' in window) {
                tests.push({
                    name: 'Cache API este suportat',
                    passed: true
                });
                
                caches.keys()
                    .then(cacheNames => {
                        tests.push({
                            name: 'Cache-uri sunt disponibile',
                            passed: cacheNames.length > 0,
                            details: `Cache-uri găsite: ${cacheNames.length}`
                        });
                        
                        displayResults(result, tests);
                    })
                    .catch(error => {
                        tests.push({
                            name: 'Cache-uri sunt disponibile',
                            passed: false,
                            details: `Eroare: ${error.message}`
                        });
                        displayResults(result, tests);
                    });
            } else {
                tests.push({
                    name: 'Cache API este suportat',
                    passed: false,
                    details: 'Cache API nu este suportat în acest browser'
                });
                displayResults(result, tests);
            }
        }
        
        function displayResults(container, tests) {
            let html = '<div class="test-results">';
            
            tests.forEach(test => {
                const className = test.passed ? 'pass' : 'fail';
                const status = test.passed ? 'PASS' : 'FAIL';
                
                html += `<div class="test-result ${className}">`;
                html += `<strong>${test.name}: ${status}</strong>`;
                if (test.details) {
                    html += `<br><small>${test.details}</small>`;
                }
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Teste automate la încărcarea paginii
        window.addEventListener('load', function() {
            console.log('PWA Test Page loaded');
        });
    </script>
</body>
</html>
